#!/usr/bin/env ruby
# vim: ft=ruby noet ts=4 sw=0 sts

require 'securerandom'
require 'yaml'

# ==============================================================================
# HELP
# ==============================================================================
command = ARGV[0]
command = 'list' if ARGV.empty?

if command == 'help'
	puts <<~HELP
	Usage: todo [command] [options]

	Commands:
	  init                    Initialize a new todo list
	  add <project> <task>    Add a new task to the todo list
	  list                    List all tasks in the todo list
	  done <id>               Mark a task as done
	  remove <id>             Remove a task from the todo list

	Options:
	  -h, --help    Show this help message
	HELP
	exit
end


# ==============================================================================
# INIT
# ==============================================================================
home = File.expand_path('~')
todo_yaml = File.join(home, '.todo.yaml')
if ARGV[0] == 'init'
	if File.exist?(todo_yaml)
		puts "USER_ERROR: Unable to run init, todo list already exists at #{todo_yaml}"
		exit 1
	end
	File.write(todo_yaml, {}.to_yaml)
	puts "Initialized todo list at #{todo_yaml}"
	exit
end


# ==============================================================================
# LOAD
# ==============================================================================
if not File.exist?(todo_yaml)
	$stderr.puts "Todo list not found at #{todo_yaml}. Please run 'todo init' first."
	exit
end
tasks = YAML.load_file(todo_yaml)


# ==============================================================================
# ADD
# ==============================================================================
if command == 'add'
	if ARGV.length < 3
		$stderr.puts "USER_ERROR: Please provide a project and task to add."
		exit 1
	end

	project = ARGV[1].upcase
	tasks[project] ||= []
	size = tasks[project].size

	summary = ARGV[2..-1].join(' ')

	task = Hash.new
	task['id'] = size + 1
	task['summary'] = summary
	task['created_at'] = Time.now
	task['finished_at'] = nil
	task['deleted_at'] = nil

	tasks[project] << task
	File.write(todo_yaml, tasks.to_yaml)
	puts "Added task '#{summary}' to project '#{project}'."
	exit
end


# ==============================================================================
# LIST
# ==============================================================================
red_circle    = 'ðŸ”´'
orange_circle = 'ðŸŸ '
yellow_circle = 'ðŸŸ¡'
green_circle  = 'ðŸŸ¢'
blue_circle   = 'ðŸ”µ'
purple_circle = 'ðŸŸ£'
black_circle  = 'âš«ï¸'
white_circle  = 'âšªï¸'
brown_circle  = 'ðŸŸ¤'

not_started = 'âŒ'
in_progress = 'â³'
done        = 'âœ…'
star        = 'â­ï¸'
urgent      = 'â—ï¸'
very_urgent = 'â€¼ï¸'
critical    = 'âš ï¸'
reminder    = 'ðŸ””'
note        = 'ðŸ“'

if command == 'list'
	if tasks.empty?
		puts "No tasks found."
	else
		tasks.each do |project, tasks|
			puts "Project: #{project}"
			tasks.each_with_index do |task, index|
				status = task['done'] ? '[x]' : '[ ]'
				puts "  #{index + 1}. #{status} #{task['summary']}"
			end
		end
	end
	exit
end


# ==============================================================================
# DUMP
# ==============================================================================



