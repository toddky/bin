#!/usr/bin/env python3

import sys
import subprocess
import html2text

if len(sys.argv) != 2:
    print("Usage: confluence-curl <confluence_url>", file=sys.stderr)
    sys.exit(1)

url = sys.argv[1]

# Fetch HTML content using existing ,curl-jira script
try:
    result = subprocess.run(
        [',curl-jira', url],
        capture_output=True,
        text=True,
        check=True
    )
    html_content = result.stdout
except subprocess.CalledProcessError as e:
    print(f"Error fetching URL: {e}", file=sys.stderr)
    sys.exit(1)

# Convert HTML to markdown
h = html2text.HTML2Text()
h.ignore_links = False  # Keep links in markdown format [text](url)
h.body_width = 0        # Don't wrap lines (unlimited width)

content = h.handle(html_content)

# Find the actual content starting from the main heading
lines = content.split('\n')
start_idx = 0
for i, line in enumerate(lines):
    if line.startswith('# ') and 'Confluence' not in line:
        start_idx = i
        break

print('\n'.join(lines[start_idx:]))

