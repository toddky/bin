#!/usr/bin/env bash
# USAGE: git-,clean [ARGS]
# DESCRIPTION: Run with -n first, then rerun if user says yes

args="$@"
if [[ -z "${args[@]}" ]]; then
	args=(-d -x)
fi

print-cmd git clean -n "${args[@]}"

paths_to_clean=()
while IFS= read -r line; do
	[[ "$line" =~ ^Would\ remove\ (.+)$ ]] || continue
	path="${BASH_REMATCH[1]}"
	if [[ "$(basename "$path")" == "__pycache__" ]]; then
		echo "Auto-deleting $path"
		rm -rf "$path" 2>/dev/null || { chmod -R +w "$path" 2>/dev/null && rm -rf "$path"; }
	else
		paths_to_clean+=("$path")
		echo "$line"
	fi
done <<< "$(git clean -n "${args[@]}")"

echo

[[ ${#paths_to_clean[@]} -eq 0 ]] && exit 0

yesno 'Continue?' || exit $?

# Delete remaining files
for path in "${paths_to_clean[@]}"; do
	echo "Deleting $path"
	rm -rf "$path" 2>/dev/null || { chmod -R +w "$path" 2>/dev/null && rm -rf "$path"; }
done

